package:
  name: test
  version: 1.0.0 # Nonsense
  tag:
    - always
  top-level:
    - test
source:
  sha256: $(PYTHON_ARCHIVE_SHA256)
  url: $(PYTHON_ARCHIVE_URL)
  patches:
    - patches/0006-Catch-permission-error-in-test.patch
build:
  type: cpython_module
  script: |
    pwd
    export TEST_EXTENSIONS="\
      _testinternalcapi.so \
      _testbuffer.so \
      _testimportmultiple.so \
      _testmultiphase.so \
      _ctypes_test.so \
    "

    CAPI_FILES=(\
      _testcapimodule.c               \
      _testcapi/buffer.c              \
      _testcapi/code.c                \
      _testcapi/datetime.c            \
      _testcapi/docstring.c           \
      _testcapi/exceptions.c          \
      _testcapi/float.c               \
      _testcapi/gc.c                  \
      _testcapi/getargs.c             \
      _testcapi/heaptype.c            \
      _testcapi/heaptype_relative.c   \
      _testcapi/immortal.c            \
      _testcapi/long.c                \
      _testcapi/mem.c                 \
      _testcapi/pyos.c                \
      _testcapi/pytime.c              \
      _testcapi/structmember.c        \
      _testcapi/unicode.c             \
      _testcapi/vectorcall.c          \
      _testcapi/vectorcall_limited.c  \
      _testcapi/watchers.c            \
    )


    export TEST_MODULE_CFLAGS="${SIDE_MODULE_CFLAGS} -I Include/ -I Include/internal/ -I ."

    emcc ${TEST_MODULE_CFLAGS} -c Modules/_testinternalcapi.c -DPy_BUILD_CORE_MODULE
    emcc ${TEST_MODULE_CFLAGS} -c Modules/_testbuffer.c
    emcc ${TEST_MODULE_CFLAGS} -c Modules/_testimportmultiple.c
    emcc ${TEST_MODULE_CFLAGS} -c Modules/_testmultiphase.c
    emcc ${TEST_MODULE_CFLAGS} -c Modules/_ctypes/_ctypes_test.c

    for file in ${CAPI_FILES[@]}; do \
      emcc ${TEST_MODULE_CFLAGS} -c Modules/$file -o Modules/${file/.c/.o}
    done

    # prepend Modules/ to each file
    TMP=${CAPI_FILES[@]/#/Modules/}
    echo $TMP

    emcc ${TMP//.c/.o} -o ${DISTDIR}/_testcapi.so ${SIDE_MODULE_LDFLAGS}

    for testname in ${TEST_EXTENSIONS}; do \
      emcc ${testname/.so/.o} -o ${DISTDIR}/$testname ${SIDE_MODULE_LDFLAGS}
    done

    cd Lib && \
      tar --exclude=__pycache__ -cf - test \
      | tar -C $DISTDIR -xf -
